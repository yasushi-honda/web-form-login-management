# 自動ログイン機能 詳細設計書

## 1. 機能概要

自動ログイン機能は、ユーザーが一度ログインした後、次回以降のアクセス時にID/パスワードの入力なしで自動的にログインできる機能です。セキュリティとユーザビリティのバランスを考慮し、ユーザーの選択によって有効/無効を切り替えられるようにします。

## 2. 技術仕様

### 2.1 クライアント側の実装

#### 2.1.1 セッションIDの保存
- **保存場所**: ブラウザのLocalStorage
- **保存キー**: `formLoginSessionId`
- **保存値**: サーバーから返されたセッションID（UUID形式）
- **保存タイミング**: ログイン成功時、かつ「自動ログイン」チェックボックスがONの場合

#### 2.1.2 自動ログイン処理
- **実行タイミング**: ログイン画面の読み込み時
- **処理内容**:
  1. LocalStorageからセッションIDを取得
  2. セッションIDが存在する場合、サーバーに認証リクエスト
  3. 認証成功時は自動的にログイン完了画面へ遷移
  4. 認証失敗時はLocalStorageのセッションIDを削除し、通常のログイン画面を表示

#### 2.1.3 rememberTokenの保存範囲

- **保存場所**: ブラウザのLocalStorage
- **スコープ**: 同一ブラウザ／プロファイルごとに管理
- **注意点**:
  - シークレット（プライベート）ウィンドウでは永続化されず、セッション終了でクリアされる
  - 別のブラウザやプロファイルでは保存されたトークンにアクセスできず、新規ログインが必要

### 2.2 サーバー側の実装

#### 2.2.1 自動ログインフラグの管理
- **保存場所**: スプレッドシート「ユーザー管理シート」
- **カラム**: 「自動ログインフラグ」（TRUE/FALSE）
- **更新タイミング**: ログイン時、ユーザーの選択に応じて更新

#### 2.2.2 セッションによる認証機能
- **関数名**: `authenticateBySession(sessionId)`
- **処理内容**:
  1. セッションIDをキーにスプレッドシートからユーザー情報を検索
  2. セッションIDが存在し、かつ自動ログインフラグがTRUEの場合は認証成功
  3. 最終ログイン日時を更新
  4. 認証結果をJSON形式で返却

## 3. 実装手順

### 3.1 サーバー側（GAS）の実装
1. `userManagement.js`に`authenticateBySession`関数を追加
2. ログイン成功時に自動ログインフラグを更新する処理を`loginUser`関数に追加
3. テスト関数の作成と動作確認

### 3.2 クライアント側の実装
1. `login.html`にLocalStorageへのセッションID保存処理を追加
2. ページ読み込み時の自動ログイン処理を追加
3. 自動ログインチェックボックスの状態をサーバーに送信する処理を追加

## 4. セキュリティ考慮事項

- セッションIDは十分な長さと複雑さを持つUUID形式を使用
- 自動ログインはユーザーが明示的に選択した場合のみ有効化
- セッションIDの有効期限を設定（例：30日間）
- 重要な操作（パスワード変更など）を行う前には再認証を要求

## 5. テスト計画

### 5.1 正常系テスト
- 自動ログイン有効時のログイン成功確認
- ブラウザ再読み込み後の自動ログイン確認
- 自動ログイン無効時の通常ログイン確認

### 5.2 異常系テスト
- 不正なセッションIDでの自動ログイン失敗確認
- セッションID削除後の挙動確認
- 自動ログインフラグがFALSEの場合の挙動確認

## 6. 今後の拡張性

- セッションの有効期限設定機能
- 複数デバイスからのログイン管理
- セキュリティレベルに応じた自動ログイン制限
