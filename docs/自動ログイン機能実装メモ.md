# 自動ログイン機能実装メモ

## 概要

ユーザーエクスペリエンス向上のため、ブラウザを閉じても自動的にログインできる機能を実装しました。Google Apps Script (GAS) の Web アプリ環境の制約を考慮し、永続トークン（rememberToken）方式を採用しています。

## 実装方法

### 1. 永続トークン方式

- ユーザー管理シートに `rememberToken` 列を追加
- ログイン時に UUID 形式のトークンを生成・保存
- LocalStorage にトークンを保存し、ブラウザをまたいで利用可能

```javascript
// トークン生成
const rememberToken = Utilities.getUuid();

// LocalStorage に保存
localStorage.setItem('rememberToken', rememberToken);
```

### 2. 認証フロー

1. ページ読み込み時に LocalStorage から永続トークンを取得
2. 自動ログイン処理中はローディングインジケータを表示
3. サーバーサイドで永続トークンの有効性を確認
4. 有効な場合は新しいセッション ID を発行
5. 無効な場合は LocalStorage をクリアしてログイン画面を表示

#### 2.1.3 rememberTokenの保存範囲

- **保存場所**: ブラウザのLocalStorage
- **スコープ**: 同一ブラウザ／プロファイルごとに管理
- **注意点**:
  - シークレット（プライベート）ウィンドウでは永続化されず、セッション終了でクリアされる
  - 別のブラウザやプロファイルでは保存されたトークンにアクセスできず、新規ログインが必要

#### 2.1.4 自動ログイン処理中のUI表示

- **ローディングインジケータ**: 処理中は全画面に半透明オーバーレイで表示
- **フォーム表示**: 処理中はフォームを半透明化（opacity: 0.3）
- **処理完了時**: 成功/失敗に関わらず適切なUI状態に復帰

### 3. ログアウト機能

- フォーム一覧画面に「ログアウト」ボタンを追加
- クリック時に LocalStorage の永続トークンをクリア
- ログイン画面へリダイレクト

## ファイル構成

- `authService.js`: 認証関連機能を集約
- `login.html`: 自動ログイン処理を実装
- `formList.html`: ログアウトボタンを追加
- `test.js`: 永続トークン認証処理を追加

### 4. ユーザーインターフェース

- 自動ログイン処理中は画面全体にローディングインジケータを表示
- 処理中はログインフォームを半透明化し、ユーザーに処理状況を視覚的に通知
- エラー発生時は適切なメッセージを表示し、通常のログインフォームに戻る

## 技術的な考慮点

### GAS Web アプリの制約

GAS の Web アプリは iframe 内で動作し、デプロイごとにサブドメインが変わるため、LocalStorage の永続性に制限があります。同一バージョンのデプロイ内では問題なく動作しますが、新しいバージョンへのデプロイ時には再ログインが必要になります。

### セキュリティ対策

1. **トークンの保護**
   - UUID 形式の予測困難なトークンを使用
   - ログアウト時に確実にトークンを削除

2. **将来的な改善点**
   - トークンの有効期限設定
   - トークンのローテーション機能
   - アクセス元 IP の検証

## 運用上の注意点

1. **自動ログイン解除方法**
   - フォーム一覧画面の「ログアウト」ボタンをクリック
   - ブラウザのキャッシュをクリア

2. **デプロイ時の注意**
   - 新バージョンデプロイ後は全ユーザーの再ログインが必要

## 今後の改善予定

- トークンの有効期限設定機能
- 複数デバイスからのログイン管理
- アクセスログの記録と異常検知
- ローディングインジケータのアニメーション改善
- 自動ログイン処理のタイムアウト設定
